
1. 避免使用标准库例程，因为很多大的库例程设法处理所有可能的情况，所以占用了庞大的内存空间



```
以一个LED闪烁的程序为例与您探讨。

 ＃i nclude<reg52.h>//包含头文件

 sbit led=P2^0;//定义位变量led，使其关联单片机管脚P2.0

 void Delayms(unsigned int t);//声明延时函数

 int main(void)//主函数（C语言程序入口函数）

 {

       while(1)

       {

             led=0;//P2.0拉低，点亮LED

             Delayms(500);//调用延时函数，延时500毫秒

             led=1;//P2.0拉高，熄灭LED

             Delayms(500);//调用延时函数，延时500毫秒

       }

       return 0;

 }

void Delayms(unsigned int t)//定义延时函数

{

        unsigned int i,j;

        for(i=0;i<t;i++)

               for(j=0;j<120;j++);//大约延时1毫秒

}

这是指示灯LED闪烁的C源码，这个源码在Keil uVision4 生成的程序代码是67个字节。下面我们就采用几个方法来提高这个程序的效率。

**一．尽量定义局部变量**

单片机程序的全局变量一般是放在通用数据存储器（RAM）中，而局部变量一般是放在特殊功能寄存器当中。处理寄存器数据的速度比处理RAM数据要快，如果在一个局部函数里调用一个全局变量将会多生成好几个代码出来。所以，少定义全局变量，多定义局部变量。如上例中，如果把延时函数里的i和j定义为全局变量，编译后程序代码会增加到79个字节，多了12个字节。

**二．省略函数声明**

在一个单片机程序里我们习惯在main函数的前面先声明被调用函数，然后在mian函数的下面再定义被调用函数。这样的写法固然是一个好习惯，但每声明一个函数会增加几个代码，而且函数形参数据类型越大、形参越多增加的代码就越多，显然这不是什么好事。如果不声明编译器又报错，怎么办？C编译器的编译顺序是从上往下编译，只要被调用的函数在主调函数调用之前定义就没有问题了。所以，笔者的习惯写法是不用事先声明函数，但要按先后顺序（被调用函数一定要在主调函数之前写好）来写函数定义，到最后再写main函数。这样做编译器不但不会报错，而且代码得到精简了。如上例中，把延时函数的声明删除了，然后把延时函数的定义搬到main函数的上面，编译后程序代码变成63个字节，减少了4个字节。

**三．省略函数形参**

函数带形参，是为了在函数调用时传递实参，不但可以避免重复代码出现，还可以通过传递不同的实参值多次调用函数且实现不同的函数功能，总体代码也会得到精简。在实际编程的时候，我们只要注意，还可以进一步精简代码。对于不是多次调用或者多次调用但实参值不变的函数我们可以省略函数形参。如上例中的延时函数，我们把它改成不带形参的函数：

void Delayms(void)//定义延时函数

 {

     unsigned int i,j;

     for(i=0;i<500;i++)

          for(j=0;j<120;j++);//大约延时1毫秒

 }

编译后，程序代码变成了56个字节，减少了11个字节。

**四．改换运算符**

也许您可能没有注意到C运算符的运用也会影响程序代码的数量。如上例中，把延时函数里的自加运算符改成自减运算符后，如：

void Delayms(unsigned int t)//定义延时函数

 {

     unsigned int i,j;

     for(i=t;i>0;i--)

          for(j=120;j>0;j--);//大约延时1毫秒

 }

编译后，程序代码变成了65个字节，减少了2个字节。

通过改换运算符能达到精简代码的例子还有：

1.把求余运算表达式改为位与运算表达式。如：b=a%8 可以改为：b=a&7。

2.把乘法运算表达式改为左移运算表达式。如：b=a*8 可以改为：b=a<<3。

3.把除法运算表达式改为右移运算表达式。如：b=a/8 可以改为：b=a>>3。

**五．选择合适的数据类型**

C语言里选择变量的数据类型很讲究，变量的数据类型过小满足不了程序的要求，变量的数据类型过大会占用太多的RAM资源。您可能还没有注意到数据类型定义也影响程序代码的大小，而且这个影响还不小。如上例中，延时函数里的局部变量j定义的数据类型明显偏大，如果把它由unsigned int改成unsigned char 。编译后，程序代码变成了59个字节，减少了8个字节。

**六．直接嵌入代码**

    在您的程序里如果某个函数只调用一次，而您又要求代码提高执行速度，建议您不要采用调用函数的形式，而应该将该函数里的代码直接嵌入主调函数里，代码执行效率会大大提高。

**七．使用效率高的C语句**

C语言里有一个三目运算符“？”，俗称“问号表达式”。很多程序员都很喜欢使用，因为它逻辑清晰表达简洁。

看这个问号表达式：c=(a>b) ? a+1 : b+1;实际上等效于以下的if…else结构：

if (a>b)  c=a+1;

else  c=b+1;

可以看到，使用问号表达式，语句相当简洁，但它的执行效率却很低，远没有if…else语句效率高。所以，当您的程序要求提高执行速度的话，建议您不要使用问号表达式了。

另外，do…while语句也比while语句的效率高。

代码的效率问题，不是我们编程中的主要问题，除了程序要求较高的执行速度或者单片机的ROM和RAM不够用的时候才会考虑。一般情况下，我们不用在乎。如果您一味追求高效率的代码，可能会影响代码的可读性和可维护性。
```


高效内存

1. 使用#pragma pack(1)字节对齐结构
2. 在结构可以包含不同类型的数据的地方使用联合
3. 使用位字段而不是整数来存储标志和小整数
4. 避免使用固定长度的字符数组来存储字符串，实现字符串池和使用指针。
5. 在存储对枚举字符串列表的引用的地方，例如字体名称，将索引而不是字符串存储到列表中
6. 使用动态内存分配时，请预先计算所需的元素数量，以避免重新分配